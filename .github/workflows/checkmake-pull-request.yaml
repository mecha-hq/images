---
name: Checkmake Pull Requests

on:
  workflow_dispatch:
  pull_request:
    paths:
      # checkmake-specific paths
      - ".github/workflows/checkmake-*.yaml"
      - "tools/checkmake/**"
      # common paths
      - ".github/actions/**"
      - ".mise.*"
      - Makefile
      - melange.rsa.pub
      - scripts/**"

jobs:
  build:
    runs-on: ubuntu-24.04
    services:
      docker:
        image: docker:dind
        options: --privileged --shm-size=2g
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dump the signing key
        run: if [ ! -f "melange.rsa" ]; then echo "${{ secrets.MELANGE_SIGNING_KEY }}" > melange.rsa; fi

      - name: Install mise
        uses: jdx/mise-action@v2
        with:
          version: 2024.11.4

      - name: Activate mise
        shell: sh
        run: echo 'eval "$(~/.local/share/mise/bin/mise activate bash)"' >> ~/.bashrc

      - name: Test build of new tool version
        uses: ./.github/actions/tool
        with:
          name: checkmake
          arch: amd64 # valid values are "amd64", "arm64" and "amd64,arm64"
          publish: "false"
        env:
          SNYK_ORG: ${{ secrets.SNYK_ORG }}
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Remove the signing key
        run: shred -v -z -u -n 5 melange.rsa
        if: always()
